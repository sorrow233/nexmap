# 软件进化足迹 (过去 48 小时)

这份文档详细记录了我们在过去 48 小时内对软件进行的一步步打磨与优化。不同于枯燥的代码提交记录，这里记录的是产品进化的完整故事 —— 从底层架构的重构，到交互体验的物理化升级，再到每一个视觉细节的精心雕琢。

## 第一阶段：架构重构与性能基石 (12月24日 下午)

为了支撑更复杂的 AI 功能和更流畅的画布体验，我们首先对系统的底层进行了大刀阔斧的重构。

### 1. LLM 服务架构的策略化转型
我们彻底重写了 AI 服务层 (`src/services/llm/`)。
- **告别混沌**：将原本臃肿的 `llm.js` 拆分为模块化的架构。
- **策略模式引入**：引入了 `ModelFactory` 和 `LLMProvider` 基类。这意味着由于我们支持了 OpenAI 和 Gemini 等多种模型，系统现在可以根据配置动态切换底层实现，而无需修改业务逻辑。
- **功能角色分离**：为了更精细地控制消耗，我们将 AI 的使用场景分为了 Chat (对话)、Extraction (提取) 和 Analysis (分析)，并支持为不同角色分配不同的模型（如 Chat 用 Pro 模型，分析用 Flash 模型）。

### 2. 画布渲染引擎升级
面对日益复杂的节点连接，如果不优化，网页会变得卡顿。
- **Canvas 渲染层**：引入了 `ConnectionLayer.jsx`，专门使用 HTML5 Canvas API 来绘制连接线，替代了原本昂贵的 SVG/DOM 节点渲染。这极大地降低了 DOM 节点数量。
- **视口剔除 (Viewport Culling)**：实现了智能渲染算法，现在只会渲染用户当前屏幕可见范围内的卡片。即使画布上有成千上万张卡片，操作依然流畅如初。

## 第二阶段：交互体验的物理化升级 (12月24日 晚间)

如果说第一阶段是修内功，这一阶段就是练招式。我们希望画布的操作手感能像物理世界一样自然。

### 3. 引入物理引擎 (React Spring)
- **丝滑手势**：引入 `@use-gesture/react` 和 `react-spring`。现在的画布缩放和平移不再是生硬的数值变化，而是有了物理惯性（Kinetic Inertia）。当你用力甩动画布时，它会像滑冰一样自然滑行一段距离后停下。
- **手势调优**：为了适配 Mac 触控板，我们反复调整了阻尼系数 (Damping)。
    - *优化前*：轻轻一滑，画布就飞出去了。
    - *优化后*：不仅防飞，还加入了防误触机制 (`overscroll-behavior: none` 和 `touch-action: manipulation`)，彻底解决了双指缩放时意外触发浏览器“后退”的尴尬。

### 4. 纠正 Canvas 回弹问题
在使用物理引擎初期，我们遇到了“画布回弹”的 Bug —— 缩放后松手，画布会像橡皮筋一样弹回。
- **精准修复**：我们重写了手势状态管理逻辑，确保缩放操作是 1:1 的直接映射，消除了不必要的弹簧效应，让缩放稳如泰山。

## 第三阶段：视觉风格的探索与定型 (12月24日 深夜)

在这个阶段，我们对产品的“颜值”进行了深入探索。

### 5. 风格尝试：日式相册风 vs 科技玻璃态
- **尝试**：我们一度尝试了温暖的日式配色（米色背景、珊瑚色点缀），试图打造温馨的氛围。
- **决策**：经过评估，我们最终决定回归并强化 **"Premium Glassmorphism" (高级玻璃拟态)** 风格。
    - **Bento Grid 布局**：主页看板列表采用了经典的 Bento 网格布局，既整齐又富有现代感。
    - **光影质感**：大幅优化了阴影 (`shadow-premium`) 和透明度，让界面元素仿佛悬浮在磨砂玻璃之上，呈现出晶莹剔透的高级感。

## 第四阶段：核心功能深化 (12月25日 凌晨)

好看的皮囊要有，有趣的灵魂更重要。我们开始打磨核心的笔记和 AI 交互功能。

### 6. 打造“大师笔记”体验 (Master Note)
- **单一真理来源**：我们重新定义了笔记的交互。现在，当你从 AI 对话中提取内容时，系统不再创建零散的小卡片，而是智能地追加到一张“Master Note”中。
- **自动序号**：为了让笔记井井有条，系统会自动分析笔记内容，为新追加的条目自动添加序号 (01., 02., 03...)。
- **防止误删**：移除了便签卡片上容易误触的删除按钮，改为需要选中后通过工具栏删除，增加了操作的安全性。

### 7. AI 响应的可靠性修复
- **流式输出修复**：解决了快速连续输入时，多个 AI 回答流导致 ID 冲突、内容互相覆盖的严重 Bug。我们通过引入纳秒级唯一 ID (`timestamp_random`) 和并发锁机制，确保哪怕你在一秒内发出 5 个问题，每一个都能得到独立且完整的回答。

## 第五阶段：用户引导与自动化布局 (12月25日 白天)

随着功能增多，如何让新用户快速上手成为了重点。

### 8. 新手引导系统 (Onboarding)
- **Welcome Canvas**：设计了一个全屏的欢迎页，通过 6 张动态卡片，向新用户演示“无限画布”、“智能连线”、“AI 对话”等核心亮点。
- **使用指南看板**：为每个新用户自动创建一个包含交互式教程的“使用指南”看板，手把手教用户如何使用这个强大的工具。

### 9. 智能布局算法 (Auto Layout)
- **思维导图模式**：引入了 MindNode 风格的自动布局算法。点击“魔棒”按钮，杂乱无章的卡片就会自动排列成整齐的树状结构（从左到右），且智能避免重叠。这对于整理 AI 生成发散的思路非常有用。
- **框选交互 (Rubber Band)**：实现了类似操作系统的蓝色半透明框选功能。现在你可以按住 Shift 或切换模式，直接框选批量操作卡片，效率倍增。

## 第六阶段：细节打磨与暗色模式 (12月25日 晚间 - 至今)

最后的 12 小时，我们专注于“最后一公里”的体验。

### 10. 便签功能的终极形态
- **Markdown 支持**：便签 (`StickyNote`) 不再是纯文本，而是完整支持 Markdown 渲染。列表、粗体、代码块都能完美显示。
- **智能尺寸**：响应用户反馈，我们将便签的默认尺寸增加了 30%，并增加了“展开/折叠”功能。双击标题栏即可收起便签，保持画布整洁。
- **滚动优化**：为了防止误触，我们设计了“智能滚动” —— 鼠标悬停 0.5 秒后才会激活滚动条，且滚动条样式经过了专门的细化，不再突兀。

### 11. 导出与分享的完善
- **所见即所得**：优化了导出图片和 PDF 的功能。
- **深色模式适配**：修复了在系统深色模式下，导出内容背景透明或文字看不清的问题。现在无论你的系统是黑是白，导出的分享卡片都能自动调整为最适合阅读的配色（Tech 主题或 Business 主题）。

---

**总结**：
在这 48 小时里， aimainmap 从一个功能的集合体，进化为了一个拥有物理手感、高级视觉、智能辅助且架构稳健的成熟产品。每一步优化，都凝聚了对“更好用的思维工具”的思考。
